import React from "react";
import {
  PieChart,
  Pie,
  Cell,
  Tooltip,
  ResponsiveContainer,
} from "recharts";

import ofertaData from "../../public/data/educacion_oferta_municipal.json";
import educacionData from "../../public/data/educacion.json";
import nivelData from "../../public/data/educacion_nivel.json";

/* ============================================================
   3 Ëâ≤„ÉÜ„Éº„ÉûÔºàEducaci√≥n „ÅÆ„Ç™„É¨„É≥„Ç∏Á≥ª UI „Å´Âêà„Çè„Åõ„ÅüÈÖçËâ≤Ôºâ
============================================================ */
const CHART_COLORS = {
  abandono: "#f59e0b",
  promocion: "#22c55e",
  reprobacion: "#ef4444",
};

/* ============================================================
   Tooltip „Ç≥„É≥„Éù„Éº„Éç„É≥„ÉàÔºàabandono/promoci√≥n/reprobaci√≥n Áî®Ôºâ
============================================================ */
function CycleTooltip({ active, payload, label }) {
  if (!active || !payload || payload.length === 0) return null;
  const item = payload[0];
  return (
    <div
      style={{
        background: "white",
        padding: "6px 10px",
        borderRadius: "6px",
        border: "1px solid #ddd",
        fontSize: "12px",
      }}
    >
      <div>
        <strong>{label}</strong>
      </div>
      <div>{item.value}% (RD: {item.payload.rd})</div>
    </div>
  );
}

/* ============================================================
   ÂçòÁ¥î„Å™ Stat „Ç´„Éº„Éâ
============================================================ */
function StatCard({ label, v, rd }) {
  if (v == null || Number.isNaN(v)) {
    return (
      <div className="rounded-xl bg-white p-4 shadow-sm border border-slate-200">
        <div className="text-xs text-slate-500">{label}</div>
        <div className="text-lg font-semibold text-slate-400">‚Äî</div>
        <div className="text-xs text-slate-400">(RD: {rd})</div>
      </div>
    );
  }

  return (
    <div className="rounded-xl bg-white p-4 shadow-sm border border-slate-200">
      <div className="text-xs text-slate-500">{label}</div>
      <div className="text-lg font-semibold">
        {v} <span className="text-xs text-slate-500">(RD: {rd})</span>
      </div>
    </div>
  );
}

/* ============================================================
   ÂÜÜ„Ç∞„É©„Éï„Ç´„Éº„ÉâÔºàInicial / Primario / SecundarioÔºâ
============================================================ */
function CycleChartCard({ title, data }) {
  const pieData = [
    {
      name: "Abandono",
      key: "abandono",
      value: data.abandono,
      rd: data.rd_abandono,
    },
    {
      name: "Promoci√≥n",
      key: "promocion",
      value: data.promocion,
      rd: data.rd_promocion,
    },
    {
      name: "Reprobaci√≥n",
      key: "reprobacion",
      value: data.reprobacion,
      rd: data.rd_reprobacion,
    },
  ];

  return (
    <div className="rounded-xl bg-white p-5 shadow-sm border border-slate-200 flex flex-col items-center">
      <h3 className="text-lg font-bold text-orange-700 mb-3">{title}</h3>

      <div className="flex items-center gap-5 w-full">
        <div className="w-40 h-40">
          <ResponsiveContainer width="100%" height="100%">
            <PieChart>
              <Pie
                data={pieData}
                dataKey="value"
                nameKey="name"
                cx="50%"
                cy="50%"
                outerRadius={70}
                innerRadius={35}
                paddingAngle={1}
              >
                {pieData.map((entry) => (
                  <Cell key={entry.key} fill={CHART_COLORS[entry.key]} />
                ))}
              </Pie>
              <Tooltip content={<CycleTooltip />} />
            </PieChart>
          </ResponsiveContainer>
        </div>

        <div className="flex-1 text-xs space-y-1">
          {pieData.map((d) => (
            <div key={d.key} className="flex justify-between items-center">
              <span
                className="font-medium"
                style={{ color: CHART_COLORS[d.key] }}
              >
                {d.name}:
              </span>
              <span>
                {d.value}%{" "}
                <span className="text-slate-500 text-xs">(RD: {d.rd})</span>
              </span>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}

/* ============================================================
   „Éë„Éº„Çª„É≥„ÉÜ„Éº„Ç∏Ë®àÁÆó„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£
============================================================ */
function toPct(value, base) {
  if (value == null || !base || base === 0) return null;
  return Number(((value * 100) / base).toFixed(1));
}

/* ========================================================
   „É°„Ç§„É≥„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà
============================================================ */
export default function EducacionDashboard({ records, selectedMunicipio }) {
  const muni = records?.[0] || null;

  if (!muni) return <div>No hay datos disponibles.</div>;

  /* --------------------------------------------------------
     Oferta Educativa ‚Äì se busca por codigo ADM2 „Åæ„Åü„ÅØ municipio
  -------------------------------------------------------- */
  const oferta = (() => {
    const candidates = [];
    if (muni.codigo_adm2 != null) {
      const code = String(muni.codigo_adm2).padStart(5, "0");
      candidates.push((o) => String(o.adm2_code).padStart(5, "0") === code);
    }
    if (muni.adm2_code != null) {
      const code = String(muni.adm2_code).padStart(5, "0");
      candidates.push((o) => String(o.adm2_code).padStart(5, "0") === code);
    }
    if (muni.municipio) {
      const name = String(muni.municipio).trim();
      candidates.push((o) => String(o.municipio).trim() === name);
    }
    for (const match of candidates) {
      const hit = ofertaData.find(match);
      if (hit) return hit;
    }
    return null;
  })();

  /* --------------------------------------------------------
     Anuario (infra / efic) ‚Äì municipio ‚Üí distrito „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
  -------------------------------------------------------- */
  let infra = muni.anuario?.infraestructura || null;
  let efic = muni.anuario?.eficiencia || null;

  const distritoCodeFromAnuario = (() => {
    const raw = muni.anuario?.distrito_educativo;
    if (!raw) return null;
    const match = String(raw).match(/\d{4}/);
    return match ? match[0] : null;
  })();

  const distritoCode =
    distritoCodeFromAnuario ||
    (oferta ? String(oferta.distrito_educativo).padStart(4, "0") : null);

  const distritoRecord = distritoCode
    ? educacionData.find(
        (d) =>
          String(d.distrito_educativo || d.distrito_educativo_code).padStart(
            4,
            "0"
          ) === distritoCode
      )
    : null;

  if (!infra && distritoRecord?.anuario?.infraestructura) {
    infra = distritoRecord.anuario.infraestructura;
  }
  if (!efic && distritoRecord?.anuario?.eficiencia) {
    efic = distritoRecord.anuario.eficiencia;
  }

  infra = infra || {};
  efic = efic || {};

  // RD national averages
  const RD = {
    inicial: { abandono: 1.4, promocion: 98.6, reprobacion: 0.0 },
    primario: { abandono: 2.6, promocion: 92.3, reprobacion: 5.1 },
    secundario: { abandono: 5.2, promocion: 88.8, reprobacion: 6.6 },
  };

  /* --------------------------------------------------------
     Nivel de instrucci√≥n ‚Äì Censo 2022 (Cuadro1)
     educacion_nivel.json „Åã„Çâ adm2_code „Åß 1 Ë°åÊãæ„ÅÜ
  -------------------------------------------------------- */
  const nivelRow = (() => {
    if (!muni.adm2_code) return null;
    const code = String(muni.adm2_code).padStart(5, "0");
    // Âêå„Åò adm2_code „ÅåË§áÊï∞„ÅÇ„Å£„Å¶„ÇÇ„ÄÅ„Å®„Çä„ÅÇ„Åà„ÅöÊúÄÂàù„ÅÆ1‰ª∂„Å†„Åë‰ΩøÁî®
    return (
      nivelData.find(
        (r) => String(r.adm2_code).padStart(5, "0") === code
      ) || null
    );
  })();

  const nivel = nivelRow?.nivel || null;

  // ÂêàË®àÔºàninguno„Äúsuperior „ÅÆ total „ÅÆÂêàË®àÔºâ
  const totalNivel =
    nivel &&
    [
      nivel.ninguno?.total ?? 0,
      nivel.preprimaria?.total ?? 0,
      nivel.primaria?.total ?? 0,
      nivel.secundaria?.total ?? 0,
      nivel.superior?.total ?? 0,
    ].reduce((a, b) => a + b, 0);

  // ÂêÑ„É¨„Éô„É´„ÅÆ % ÔºàÂêàË®à„Å´ÂØæ„Åô„ÇãÂâ≤ÂêàÔºâ
  const pct = nivel
    ? {
        ninguno: toPct(nivel.ninguno?.total, totalNivel),
        preprimaria: toPct(nivel.preprimaria?.total, totalNivel),
        primaria: toPct(nivel.primaria?.total, totalNivel),
        secundaria: toPct(nivel.secundaria?.total, totalNivel),
        superior: toPct(nivel.superior?.total, totalNivel),
      }
    : null;

  // ÂÜÜ„Ç∞„É©„ÉïÁî®„Éá„Éº„Çø
  const nivelPieData =
    nivel && pct
      ? [
          {
            name: "Ninguno",
            key: "ninguno",
            value: pct.ninguno ?? 0,
          },
          {
            name: "Preprimaria",
            key: "preprimaria",
            value: pct.preprimaria ?? 0,
          },
          {
            name: "Primaria/B√°sica",
            key: "primaria",
            value: pct.primaria ?? 0,
          },
          {
            name: "Secundaria/Media",
            key: "secundaria",
            value: pct.secundaria ?? 0,
          },
          {
            name: "Universitaria/Superior",
            key: "superior",
            value: pct.superior ?? 0,
          },
        ]
      : [];

  // „É¨„Éô„É´ÂÜÖÈÉ®„Åß„ÅÆ urbano/rural H/M „ÅÆÂâ≤ÂêàÔºà„Åù„ÅÆ„É¨„Éô„É´ total „Å´ÂØæ„Åô„Çã %Ôºâ
  function levelShares(levelObj) {
    if (!levelObj) return null;
    const base = levelObj.total ?? 0;
    if (!base) return null;
    return {
      urbano_h: toPct(levelObj.urbano_h, base),
      urbano_m: toPct(levelObj.urbano_m, base),
      rural_h: toPct(levelObj.rural_h, base),
      rural_m: toPct(levelObj.rural_m, base),
    };
  }

  const shares = nivel
    ? {
        ninguno: levelShares(nivel.ninguno),
        preprimaria: levelShares(nivel.preprimaria),
        primaria: levelShares(nivel.primaria),
        secundaria: levelShares(nivel.secundaria),
        superior: levelShares(nivel.superior),
      }
    : null;

  return (
    <div className="my-6 rounded-2xl border border-orange-200 bg-orange-50 p-6 shadow-sm">
      {/* HEADER */}
      <div className="flex items-center gap-3 mb-4">
        <div className="h-10 w-10 bg-orange-200 rounded-full flex items-center justify-center">
          <span className="text-2xl">üéì</span>
        </div>
        <h2 className="text-xl font-bold text-orange-700">
          Educaci√≥n ‚Äì contexto general
        </h2>
      </div>

      <h3 className="text-lg font-semibold">
        {selectedMunicipio?.municipio || muni.municipio}
      </h3>
      <div className="text-sm text-slate-600 mb-3">
        Provincia: {selectedMunicipio?.provincia || muni.provincia}
      </div>

      {/* Oferta Educativa ‚Äì Municipio */}
      <div className="mb-6 rounded-xl bg-white p-4 shadow-sm border border-slate-200">
        <h3 className="font-semibold text-orange-700 mb-2">
          Oferta Educativa ‚Äì Municipio {muni.municipio}
        </h3>

        {oferta ? (
          <>
            <p>
              <strong>Total centros educativos:</strong>{" "}
              {oferta.centros_total}
            </p>

            <p className="mt-1">
              <strong>Inicial‚ÄìPrimario:</strong>{" "}
              {oferta.niveles?.inicial_primario?.centros} centros (
              {oferta.niveles?.inicial_primario?.matricula} estudiantes)
            </p>

            <p className="mt-1">
              <strong>Secundario:</strong>{" "}
              {oferta.niveles?.secundario?.centros} centros (
              {oferta.niveles?.secundario?.matricula} estudiantes)
            </p>

            <p className="mt-1">
              <strong>Adultos:</strong>{" "}
              {oferta.niveles?.adultos?.centros} centros (
              {oferta.niveles?.adultos?.matricula} estudiantes)
            </p>
          </>
        ) : (
          <p className="text-sm text-slate-500">
            No hay datos sobre oferta educativa para este municipio.
          </p>
        )}
      </div>

      {/* Distrito Educativo */}
      {(() => {
        const labelFromAnuario = muni.anuario?.distrito_educativo;
        const labelFromOferta = oferta
          ? `${oferta.distrito_educativo} ${oferta.distrito_nombre}`
          : null;
        const label = labelFromAnuario || labelFromOferta;

        return (
          <div className="mb-4">
            <div className="flex items-baseline gap-2">
              <span className="text-sm font-semibold text-slate-700">
                Distrito educativo
              </span>
              <span className="text-base font-semibold text-slate-900">
                {label || "‚Äî"}
              </span>
            </div>
            <p className="mt-1 text-xs text-slate-500">
              Los indicadores siguientes (infraestructura y eficiencia)
              corresponden al distrito educativo, no s√≥lo al municipio.
            </p>
          </div>
        );
      })()}

      {/* Infraestructura */}
      <h3 className="font-semibold text-slate-700 mb-2">
        Infraestructura educativa
      </h3>
      <div className="grid gap-3 md:grid-cols-4">
        <StatCard
          label="Aulas por plantel"
          v={infra.aulas_por_plantel}
          rd={8.8}
        />
        <StatCard
          label="Secciones por centro"
          v={infra.secciones_por_centro}
          rd={9.8}
        />
        <StatCard
          label="Secciones por aula"
          v={infra.secciones_por_aula}
          rd={1.3}
        />
        <StatCard
          label="Docentes por centro"
          v={infra.docentes_por_centro}
          rd={16.5}
        />
        <StatCard
          label="Alumnos por centro"
          v={infra.alumnos_por_centro}
          rd={202.7}
        />
        <StatCard
          label="Alumnos por aula"
          v={infra.alumnos_por_aula}
          rd={27.2}
        />
        <StatCard
          label="Alumnos por secci√≥n"
          v={infra.alumnos_por_seccion}
          rd={20}
        />
        <StatCard
          label="Alumnos por docente"
          v={infra.alumnos_por_docente}
          rd={12.9}
        />
      </div>

      {/* Eficiencia */}
      <h3 className="font-semibold text-slate-700 mt-6 mb-3">
        Eficiencia del sistema educativo
      </h3>
      <div className="grid md:grid-cols-3 gap-4">
        <CycleChartCard
          title="Inicial"
          data={{
            abandono: efic.inicial?.abandono ?? null,
            promocion: efic.inicial?.promocion ?? null,
            reprobacion: efic.inicial?.reprobacion ?? null,
            rd_abandono: RD.inicial.abandono,
            rd_promocion: RD.inicial.promocion,
            rd_reprobacion: RD.inicial.reprobacion,
          }}
        />
        <CycleChartCard
          title="Primario"
          data={{
            abandono: efic.primario?.abandono ?? null,
            promocion: efic.primario?.promocion ?? null,
            reprobacion: efic.primario?.reprobacion ?? null,
            rd_abandono: RD.primario.abandono,
            rd_promocion: RD.primario.promocion,
            rd_reprobacion: RD.primario.reprobacion,
          }}
        />
        <CycleChartCard
          title="Secundario"
          data={{
            abandono: efic.secundario?.abandono ?? null,
            promocion: efic.secundario?.promocion ?? null,
            reprobacion: efic.secundario?.reprobacion ?? null,
            rd_abandono: RD.secundario.abandono,
            rd_promocion: RD.secundario.promocion,
            rd_reprobacion: RD.secundario.reprobacion,
          }}
        />
      </div>

      <p className="mt-4 text-[10px] text-slate-500">
        Fuente: MINERD, Anuario Estad√≠stico Educativo y Censo 2022.
      </p>

      {/* Nivel de instrucci√≥n ‚Äì Cuadro1 (Censo 2022) */}
      {nivel && pct && shares && (
        <div className="mt-10 rounded-xl bg-white p-4 shadow-sm border border-slate-200">
          <h3 className="font-semibold text-orange-700 mb-3">
            Nivel de instrucci√≥n ‚Äì Censo 2022
          </h3>

          <div className="grid md:grid-cols-2 gap-4">
            {/* „Éâ„Éº„Éä„ÉÑ„ÉÅ„É£„Éº„Éà */}
            <div className="h-64">
              <ResponsiveContainer width="100%" height="100%">
                <PieChart>
                  <Pie
                    data={nivelPieData}
                    dataKey="value"
                    nameKey="name"
                    cx="50%"
                    cy="50%"
                    outerRadius={80}
                    innerRadius={40}
                  >
                    <Cell fill="#94a3b8" /> {/* Ninguno */}
                    <Cell fill="#38bdf8" /> {/* Preprimaria */}
                    <Cell fill="#34d399" /> {/* Primaria */}
                    <Cell fill="#fbbf24" /> {/* Secundaria */}
                    <Cell fill="#f43f5e" /> {/* Superior */}
                  </Pie>
                </PieChart>
              </ResponsiveContainer>
            </div>

            {/* „ÉÜ„Ç≠„Çπ„ÉàË°®Á§∫ */}
            <div className="text-sm space-y-2">
              {/* Ninguno */}
              <p>
                <strong>Ninguno:</strong>{" "}
                {pct.ninguno != null ? `${pct.ninguno}%` : "‚Äî"}{" "}
                {shares.ninguno && (
                  <span className="text-slate-500">
                    {" "}
                    (Urbano H:{shares.ninguno.urbano_h ?? "‚Äî"} / M:
                    {shares.ninguno.urbano_m ?? "‚Äî"}, Rural H:
                    {shares.ninguno.rural_h ?? "‚Äî"} / M:
                    {shares.ninguno.rural_m ?? "‚Äî"})
                  </span>
                )}
              </p>

              {/* Preprimaria */}
              <p>
                <strong>Preprimaria:</strong>{" "}
                {pct.preprimaria != null ? `${pct.preprimaria}%` : "‚Äî"}{" "}
                {shares.preprimaria && (
                  <span className="text-slate-500">
                    {" "}
                    (Urbano H:{shares.preprimaria.urbano_h ?? "‚Äî"} / M:
                    {shares.preprimaria.urbano_m ?? "‚Äî"}, Rural H:
                    {shares.preprimaria.rural_h ?? "‚Äî"} / M:
                    {shares.preprimaria.rural_m ?? "‚Äî"})
                  </span>
                )}
              </p>

              {/* Primaria / B√°sica */}
              <p>
                <strong>Primaria/B√°sica:</strong>{" "}
                {pct.primaria != null ? `${pct.primaria}%` : "‚Äî"}{" "}
                {shares.primaria && (
                  <span className="text-slate-500">
                    {" "}
                    (Urbano H:{shares.primaria.urbano_h ?? "‚Äî"} / M:
                    {shares.primaria.urbano_m ?? "‚Äî"}, Rural H:
                    {shares.primaria.rural_h ?? "‚Äî"} / M:
                    {shares.primaria.rural_m ?? "‚Äî"})
                  </span>
                )}
              </p>

              {/* Secundaria / Media */}
              <p>
                <strong>Secundaria/Media:</strong>{" "}
                {pct.secundaria != null ? `${pct.secundaria}%` : "‚Äî"}{" "}
                {shares.secundaria && (
                  <span className="text-slate-500">
                    {" "}
                    (Urbano H:{shares.secundaria.urbano_h ?? "‚Äî"} / M:
                    {shares.secundaria.urbano_m ?? "‚Äî"}, Rural H:
                    {shares.secundaria.rural_h ?? "‚Äî"} / M:
                    {shares.secundaria.rural_m ?? "‚Äî"})
                  </span>
                )}
              </p>

              {/* Universitaria / Superior */}
              <p>
                <strong>Universitaria/Superior:</strong>{" "}
                {pct.superior != null ? `${pct.superior}%` : "‚Äî"}{" "}
                {shares.superior && (
                  <span className="text-slate-500">
                    {" "}
                    (Urbano H:{shares.superior.urbano_h ?? "‚Äî"} / M:
                    {shares.superior.urbano_m ?? "‚Äî"}, Rural H:
                    {shares.superior.rural_h ?? "‚Äî"} / M:
                    {shares.superior.rural_m ?? "‚Äî"})
                  </span>
                )}
              </p>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
